---
title: 'Visualizing Models'
tags: [r]
output: html_document
    # md_document:
    #   variant: markdown_github
---

```{r, warning = FALSE, message = FALSE, include = FALSE}
library(knitr)

opts_chunk$set(
    cache = TRUE, warning = FALSE, message = FALSE, dpi = 150, fig.show = "animate")
```

Really wanted to write somethng for super bowl.
don't really know anything about football.. but will watch

tried to precit who will will


Model diagnoistics
visualizatior diagnotistics
pred grid

p-hacking .... could have find something.
looking at pvalues and like... ooop!

wanted to tell a story,

that's okay 90% of my work is throw out. And it has to be that way. sometimes things just don't pan out. but that's not what textbooks tell you. everything you read has an answer. that's not how the real world works. it's messy and sometimes the data just inst there.

showed what I want to show.

```{r warning=FALSE, message=FALSE}
library(tidyverse)
library(viridis)
```

```{r include = FALSE}
library(stringr)
library(purrr)
library(rvest)

# scrape and format data

pfr <- tribble(
    ~team, ~ticker,
    "Arizona Cardinals", "crd",
    "Atlanta Falcons", "atl",
    "Baltimore Ravens", "rav",
    "Buffalo Bills", "buf",
    "Carolina Panthers", "car",
    "Chicago Bears", "chi",
    "Cincinnati Bengals", "cin",
    "Cleveland Browns", "cle",
    "Dallas Cowboys", "dal",
    "Denver Broncos", "den",
    "Detroit Lions", "det",
    "Green Bay Packers", "gnb",
    "Houston Texans", "htx",
    "Indianapolis Colts", "clt",
    "Jacksonville Jaguars", "jax",
    "Kansas City Chiefs", "kan",
    "Los Angeles Rams", "ram",
    "Miami Dolphins", "mia",
    "Minnesota Vikings", "min",
    "New England Patriots", "nwe",
    "New Orleans Saints", "nor",
    "New York Giants", "nyg",
    "New York Jets", "nyj",
    "Oakland Raiders", "rai",
    "Philadelphia Eagles", "phi",
    "Pittsburgh Steelers", "pit",
    "San Diego Chargers", "sdg",
    "San Francisco 49ers", "sfo",
    "Seattle Seahawks", "sea",
    "Tampa Bay Buccaneers", "tam",
    "Tennessee Titans", "oti",
    "Washington Redskins", "was")

ticker <- pfr %>% 
    select(ticker) %>% 
    t(.) %>% 
    as.vector(.)

params <- expand.grid(ticker = ticker, year = 2002:2016) %>% 
    mutate(ticker = as.character(ticker))

scrape_pfr <- function(ticker = "atl", year = 2016) {
    
    url <- str_c(
        "http://www.pro-football-reference.com/teams/", 
        ticker, "/", year, ".htm")
    
    page <- read_html(url)
    
    record <- page %>%
        html_nodes(".prevnext+ p") %>% 
        html_text() 
    
    pf <- page %>%
        html_nodes("#meta p:nth-child(5)") %>% 
        html_text() 
    
    pa <- page %>%
        html_nodes("#meta p:nth-child(6)") %>% 
        html_text() 
    
    expected <- page %>%
        html_nodes("#meta p:nth-child(7)") %>% 
        html_text() 
    
    comp <- page %>%
        html_nodes("#meta p:nth-child(8)") %>% 
        html_text() 
    
    df <- tibble(ticker, year, record, pf, pa, expected, comp)
    
    return(df)
}

pfr_data <- params %>% 
    pmap(scrape_pfr) %>% 
    bind_rows()

# cache

write_csv(pfr_data, "pfr_data.csv")
pfr_data <- read_csv("pfr_data.csv")

# reformat

record <- pfr_data %>% 
    mutate(srs = comp) %>% 
    mutate(srs = str_replace(srs, "^[^\\:\\s]*\\:\\s", "")) %>% 
    mutate(srs = str_replace(srs, "\\(.*", "")) %>% 
    mutate(srs = str_replace(srs, "\\sSOS.*$", "")) %>% 
    mutate(srs = parse_number(srs)) %>% 
    mutate(pa = str_replace(pa, "\\/.*$", "")) %>% 
    mutate(pa = str_replace(pa, "^(.*?\\()", "")) %>% 
    mutate(pf = str_replace(pf, "\\/.*$", "")) %>% 
    mutate(pf = str_replace(pf, "^(.*?\\()", "")) %>% 
    mutate(pf = as.numeric(pf), pa = as.numeric(pa)) %>% 
    select(ticker, year, srs, pf, pa) %>%
    left_join(pfr, by = "ticker")

# super bowl collection

superbowl <- tribble(
    ~superbowl, ~winner, ~loser,
    50, "Denver Broncos", "Carolina Panthers", 
    49, "New England Patriots", "Seattle Seahawks", 
    48, "Seattle Seahawks", "Denver Broncos", 
    47, "Baltimore Ravens", "San Francisco 49ers", 
    46, "New York Giants", "New England Patriots",
    45, "Green Bay Packers", "Pittsburgh Steelers",
    44, "New Orleans Saints", "Indianapolis Colts",
    43, "Pittsburgh Steelers", "Arizona Cardinals",
    42, "New York Giants", "New England Patriots",
    41, "Indianapolis Colts", "Chicago Bears",
    40, "Pittsburgh Steelers", "Seattle Seahawks",
    39, "New England Patriots", "Philadelphia Eagles",
    38, "New England Patriots", "Carolina Panthers",
    37, "Tampa Bay Buccaneers", "Oakland Raiders"
    ) %>% 
    mutate(year_superbowl = 1966 + superbowl) %>% 
    mutate(year_season = year_superbowl - 1) %>% 
    select(-year_superbowl)

# final format

superbowl_data <- superbowl %>% 
    gather(result, team, -superbowl, -year_season) %>% 
    left_join(record, by = c("team", "year_season" = "year")) %>% 
    mutate(win = ifelse(result == "winner", 1, 0)) %>% 
    select(superbowl, year_season, team, win, pf, pa, srs)

# cache final form
write_csv(superbowl_data, "superbowl_data.csv")
superbowl_data <- read_csv("superbowl_data.csv")
```

```{r}
mod1 <- glm(
    win ~ pf:srs + pa:srs,
    family = "binomial",
    data = df)
summary(mod1)

pred_grid <- expand.grid(
    pf = 0:40, 
    pa = 0:40, 
    srs = -20:20) 

pred_grid$prob <- predict(mod1, newdata = pred_grid, type = "response")
```

```{r}
pred_grid %>% 
    ggplot(aes(x = pf_diff, y = pa_diff)) + 
    geom_tile(aes(fill = prob)) + 
    geom_contour(aes(z = prob), color = "white", lty = 2, binwidth = 0.25) +
    geom_point(
        data = (df %>% filter(win == 1)),
        color = "white", shape = 16, size = 2) +
    geom_point(
        data = (df %>% filter(win == 0)),
        color = "white", shape = 4, size = 2) +
    scale_fill_viridis(direction = 1, end = 0.85, option = "D") + 
    # coord_cartesian(xlim = c(10, 40), ylim = c(10, 40)) + 
    theme_minimal()
```

http://www.pro-football-reference.com/teams/atl/2016.htm#all_team_stats

```{r}
ranking <- tribble(
    ~year, ~team, ~off_ranking, ~def_ranking,
    2015, "Denver Broncos", 19, 4,
    2015, "Carolina Panthers", 1, 6, 
    2014, "New England Patriots", 4, 8,
    2014, "Seattle Seahawks", 10, 1, 
    2013, "Seattle Seahawks", 8, 1, 
    2013, "Denver Broncos", 1, 22,
    2012, "Baltimore Ravens", 10, 12,
    2012, "San Francisco 49ers", 11, 2, 
    2011, "New York Giants", 9, 25,
    2011, "New England Patriots", 3, 15, 
    2010, "Green Bay Packers", 10, 2,  
    2010, "Pittsburgh Steelers", 12, 1,
    2009, "New Orleans Saints", 1, 20,
    2009, "Indianapolis Colts", 7, 8, 
    2008, "Pittsburgh Steelers", 20, 1,
    2008, "Arizona Cardinals", 3, 28,
    2007, "New York Giants", 14, 17,
    2007, "New England Patriots", 1, 4,
    2006, "Indianapolis Colts", 2, 23, 
    2006, "Chicago Bears", 2, 3,
    2005, "Pittsburgh Steelers", 9, 3,
    2005, "Seattle Seahawks", 1, 7,
    2004, "New England Patriots", 4, 2,
    2004, "Philadelphia Eagles", 8, 2, 
    2003, "New England Patriots", 12, 1,
    2003, "Carolina Pathers", 15, 10,
    2002, "Tampa Bay Buccaneers", 18, 1, 
    2002, "Oakland Raiders", 2, 6,
    2001, "New England Patriots", 6, 6, 
    2001, "St. Louis Rams", 1, 7
)
```

```{r}
df <- superbowl %>% 
    gather(result, team, -superbowl, -year_season) %>% 
    left_join(ranking, by = c("team", "year_season" = "year")) %>%
    group_by(year_season) %>% 
    mutate(off_percentile = 1 - (off_ranking / 32)) %>% 
    mutate(def_percentile = 1 - (def_ranking / 32)) %>% 
    mutate(win = ifelse(result == "winner", 1, 0)) %>% 
    mutate(off_diff = (off_percentile - mean(off_percentile ))*2) %>% 
    mutate(def_diff = (def_percentile - mean(def_percentile ))*2)
    
    mutate(win = ifelse(result == "winner", 1, 0)) %>% 
    filter(win == 1) %>% 
    group_by(year_season) %>% 
    complete(off_ranking = seq(1, 32, 1), def_ranking = seq(1, 32, 1)) %>% 
    mutate(win = ifelse(is.na(win), 0, 1))
```

```{r}
mod2 <- glm(
    win ~ off_diff + def_diff,
    family = "binomial",
    data = df)
summary(mod2)

pred_grid <- expand.grid(
    off_diff = seq(-1, 1, 0.05), 
    def_diff = seq(-1, 1, 0.05))

pred_grid$prob <- predict(mod2, newdata = pred_grid, type = "response")
```

```{r}
pred_grid %>% 
    ggplot(aes(x = off_diff, y = def_diff)) + 
    geom_tile(aes(fill = prob)) + 
    geom_contour(aes(z = prob), color = "white", lty = 2, binwidth = 0.2) +
    geom_point(
        data = (df %>% filter(win == 1)),
        color = "white", shape = 16, size = 2) +
    # geom_point(
    #     data = (df %>% filter(win == 0)),
    #     color = "white", shape = 4, size = 2) +
    scale_fill_viridis(direction = 1, end = 0.85, option = "D") + 
    # coord_cartesian(xlim = c(10, 40), ylim = c(10, 40)) + 
    theme_minimal()
```







