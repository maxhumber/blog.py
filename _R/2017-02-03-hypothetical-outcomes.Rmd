---
title: 'Hypothetical Outcome Plots'
tags: [r]
output: html_document
    # md_document:
    #   variant: markdown_github
---

```{r, warning = FALSE, message = FALSE, include = FALSE}
library(knitr)
library(animation)
ani.options(autobrowse = FALSE, interval = 0.5)

opts_knit$set(animation.fun = function(x, options, format = "gif") {
    x = c(knitr:::sans_ext(x), knitr:::file_ext(x))
    fig.num = options$fig.num
    format = sub("^[.]", "", format)
    fig.fname = paste0(sub(paste0(fig.num, "$"), "*", x[1]), 
                     ".", x[2])
    mov.fname = paste0(sub(paste0(fig.num, "$"), "", x[1]), ".", 
                     format)
    
    # order correctly
    figs <- Sys.glob(fig.fname)
    figs <- figs[order(as.numeric(stringr::str_match(figs, paste0("(\\d+)\\.", x[2]))[, 2]))]
    
    animation::im.convert(figs, output = mov.fname)
    
    sprintf("![%s](%s)", options$label, paste0(opts_knit$get("base.url"), mov.fname))
})

opts_chunk$set(
    cache = TRUE, warning = FALSE, message = FALSE, dpi = 150, fig.show = "animate")
```

```{r}
suppressPackageStartupMessages(library(tidyverse))
# devtools::install_github("dgrtwo/gganimate")
# install.packages("cowplot")
library(gganimate)
# install image magick in terminal >> "brew install image magick"
```

Communicating uncertainty is hard. It's hard because uncertainty can be convoluted and opaque. And it's hard because a lot of people can't get down with boxplots or measures of spread.

Take this toy data for example:

```{r}
set.seed(2017)

df <- tibble(
<<<<<<< HEAD
    `Blue Team` = round(rnorm(50, mean = 48, sd = 5)), 
    `Red Team` = `Blue Team` + round(rnorm(50, mean = -1, sd = 3))
    ) %>% 
    mutate(simulation = row_number()) %>% 
    gather(team, polling, -simulation) %>% 
    mutate(polling = ifelse(polling >= 100, 100, polling) / 100)
=======
    Seinfeld = round(rnorm(50, mean = 81, sd = 10)), 
    `Rick and Morty` = round(rnorm(50, mean = 85, sd = 5))
    ) %>% 
    mutate(episode = row_number()) %>% 
    gather(tv_show, rating, -episode) %>% 
    mutate(rating = ifelse(rating >= 100, 100, rating) / 100)
>>>>>>> parent of e2581a4... HOP Post
```

Here we have the (fake) ratings for 50 episodes of two TV shows, *Rick and Morty* and *Seinfeld*. 

Which of these shows is better? If we didn't exactly know the distributions of this data, there would be some uncertainty in our answer. 

To figure out which show is better we might push the data through a boxplot:

```{r}
df %>% 
<<<<<<< HEAD
    ggplot(aes(x = team, y = polling)) +
=======
    ggplot(aes(x = tv_show, y = rating)) +
>>>>>>> parent of e2581a4... HOP Post
    geom_boxplot()
```

Or a density chart: 

```{r}
df %>% 
<<<<<<< HEAD
    ggplot(aes(x = polling, fill = team)) + 
    geom_density(alpha = 1/2) + 
    scale_fill_manual(values = c("blue", "red"))
=======
    ggplot(aes(x = rating, fill = tv_show)) + 
    geom_density(alpha = 1/2)
>>>>>>> parent of e2581a4... HOP Post
```

Or use some errorbars:

```{r}
df %>% 
    group_by(tv_show) %>% 
    summarise(
<<<<<<< HEAD
        mean = mean(polling), 
        low = quantile(polling, 0.025),
        high = quantile(polling, 0.975)) %>% 
    ggplot(aes(x = team, y = mean)) +
=======
        mean = mean(rating), 
        low = quantile(rating, 0.025),
        high = quantile(rating, 0.975)) %>% 
    ggplot(aes(x = tv_show, y = mean)) +
>>>>>>> parent of e2581a4... HOP Post
    geom_errorbar(aes(ymin = low, ymax = high))
```

Or we might even go HAM and build some model on it. 

But these options all kind of suck. They're not super intuitive. And they aren't all that convincing, because they intimidate a lot of people!

Instead of boxplots or density charts or regular errorbars we can hack errorbars to generate a proto-Hypothetical Outcome Plot:

```{r}
df %>% 
<<<<<<< HEAD
    ggplot(aes(x = team, y = polling)) +
    geom_errorbar(aes(ymin = polling, ymax = polling))
=======
    ggplot(aes(x = tv_show, y = rating)) +
    geom_errorbar(aes(ymin = rating, ymax = rating))
>>>>>>> parent of e2581a4... HOP Post
```

Hypothetical Outcome Plots (HOPs) are a way to build and visualize uncertainty in the same way that we experience it (in and by countable events). The depth and theory behind HOPs is beyond the scope of this quick post, but if you're interested in learning more check out [this Medium story](https://medium.com/hci-design-at-uw/hypothetical-outcomes-plots-experiencing-the-uncertain-b9ea60d7c740#.taennvi6g) by the *UW Interactive Data Lab*. 

Extending our hacked errorbars with `gganimate` we can implement an actual HOP in just a few lines of R:

```{r, fig.width=6, fig.height=4}
p <- df %>% 
<<<<<<< HEAD
    ggplot(aes(x = team, y = polling, frame = simulation)) +
    geom_errorbar(aes(ymin = polling, ymax = polling))
=======
    ggplot(aes(x = tv_show, y = rating, frame = episode)) +
    geom_errorbar(aes(ymin = rating, ymax = rating))
>>>>>>> parent of e2581a4... HOP Post

gganimate(p, title_frame = FALSE)
```

Cool. Looks like *Seinfeld* is all over the place and *Rick & Morty* is a little bit more consistent (and better**)

I hope HOPs get some more love in the future, because I really do they they're a good way to visualize and communicate uncertainty. Or at least that they're better than boxplots 


We can extend the HOP a bit further with some ghost bars:

```{r, fig.width=6, fig.height=4}
p <- df %>%
<<<<<<< HEAD
    ggplot(aes(x = team, y = polling)) +
    geom_errorbar(aes(
        ymin = polling, ymax = polling, 
        frame = simulation, cumulative = TRUE), 
        color = "grey80", alpha = 1/8) +
    geom_errorbar(aes(
        ymin = polling, ymax = polling, frame = simulation), 
=======
    ggplot(aes(x = tv_show, y = rating)) +
    geom_errorbar(aes(
        ymin = rating, ymax = rating, 
        frame = episode, cumulative = TRUE), 
        color = "grey80", alpha = 1/8) +
    geom_errorbar(aes(
        ymin = rating, ymax = rating, frame = episode), 
>>>>>>> parent of e2581a4... HOP Post
        color = "#00a9e0") +
    scale_y_continuous(
        limits = c(0, 1), 
        labels = scales::percent_format()) +
    theme(panel.background = element_rect(fill = "#FFFFFF")) +
<<<<<<< HEAD
    labs(title = "", y = "Polling %", x = "")
=======
    labs(title = "TV Shows", y = "Rating", x = "")
>>>>>>> parent of e2581a4... HOP Post

gganimate(p, title_frame = FALSE)
```

And/or sprinkle in some colour:

```{r}
df_col <- df %>%
    spread(tv_show, rating) %>% 
    mutate(better = ifelse(
        `Rick and Morty` >= Seinfeld, "Rick and Morty", "Seinfeld")) %>%
    gather(tv_show, rating, -episode, -better) %>%
    mutate(col = ifelse(better == tv_show, "green", "red"))

p <- df_col %>%
    ggplot(aes(x = tv_show, y = rating)) +
    geom_errorbar(aes(
        ymin = rating, ymax = rating, 
        frame = episode, cumulative = TRUE), 
        color = "grey80", alpha = 1/8) +
    geom_errorbar(aes(
        ymin = rating, ymax = rating, 
        color = col, frame = episode), 
        size = 1.5, alpha = 1/2, show.legend = FALSE) +
    scale_color_manual(values = c("#8FB339", "#FF1B1C")) +
    scale_y_continuous(
        limits = c(0, 1), 
        labels = scales::percent_format()) +
    theme(panel.background = element_rect(fill = "#FFFFFF")) +
    labs(title = "TV Shows", y = "Rating", x = "")

gganimate(p, title_frame = FALSE)
```