<!DOCTYPE html>
<html lang="en">
  <head>
    <!-- Global site tag (gtag.js) - Google Analytics -->
    <script async src="https://www.googletagmanager.com/gtag/js?id=UA-89691472-1"></script>
    <script>
      window.dataLayer = window.dataLayer || [];
      function gtag(){dataLayer.push(arguments);}
      gtag('js', new Date());
      gtag('config', 'UA-89691472-1');
    </script>
    <!-- Required meta tags -->
    <title>Max Humber</title>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
    <!-- Bootstrap CSS -->
    <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.3.1/css/bootstrap.min.css" integrity="sha384-ggOyR0iXCbMQv3Xipma34MD+dH/1fQ784/j6cY/iJTQUOhcWr7x9JvoRxT2MZw1T" crossorigin="anonymous">
    <!-- Code Hilite CSS -->
    <link rel="stylesheet" type="text/css" href="static/default.css">
    <!-- Custom CSS -->
    <style>
      .container {
          font-family: -apple-system, BlinkMacSystemFont, Segoe UI, Helvetica, Arial, sans-serif;
          font-size: 16px;
          font-weight: 400;
      }
      .jumbotron {
        background-color:transparent !important;
        margin-right: auto;
        margin-left: auto;
        max-width: 650px;
      }
    </style>
  </head>
  <body>
    <br/>
    <br/>
    <ul class="nav justify-content-center">
      <li class="nav-item">
        <a class="nav-link active" href="/">
          <img src="static/signature.png" class="d-inline-block align-top" alt="" title="" style="" height="75">
        </a>
      </li>
    </ul>
    <div class="container mt-3">
      <div class="jumbotron">
  <h4>How to Win Fantasy Hockey</h4>

<p><em>A recipe for using python to scrape player projection data and build a value over replacement ranking model</em></p>

<p>Jupyter notebook for this blog post available <a href="https://github.com/maxhumber/maxhumber.com/blob/master/blog/2019-09-28_scraping_fantasy_hockey.ipynb">here</a>
</br>
</br></p>

<p>1) Identify a data source (<a href="https://www.cbssports.com/fantasy/hockey/stats/F/2019/season/projections/">CBS Sports</a> is a good option)</p>

<p>2) get the html data with <a href="https://maxhumber.github.io/gazpacho/">gazpacho</a></p>

<div class="codehilite"><pre><span></span><code><span class="kn">from</span> <span class="nn">gazpacho</span> <span class="kn">import</span> <span class="n">get</span>

<span class="n">position</span> <span class="o">=</span> <span class="s1">&#39;F&#39;</span>

<span class="n">base</span> <span class="o">=</span> <span class="n">f</span><span class="s1">&#39;https://www.cbssports.com/fantasy/hockey/stats&#39;</span>
<span class="n">url</span> <span class="o">=</span> <span class="n">f</span><span class="s1">&#39;{base}/{position}/2019/season/projections/&#39;</span>

<span class="n">html</span> <span class="o">=</span> <span class="n">get</span><span class="p">(</span><span class="n">url</span><span class="p">)</span>
</code></pre></div>



<br/>
3) Pass the captured html to a Soup parser

<div class="codehilite"><pre><span></span><code><span class="kn">from</span> <span class="nn">gazpacho</span> <span class="kn">import</span> <span class="n">Soup</span>

<span class="n">soup</span> <span class="o">=</span> <span class="n">Soup</span><span class="p">(</span><span class="n">html</span><span class="p">)</span>
</code></pre></div>



<br/>
4) find the html tags that contain player projection data

<div class="codehilite"><pre><span></span><code><span class="c1"># HTML: &lt;tr class=&quot;TableBase-bodyTr &quot;&gt;</span>
<span class="n">rows</span> <span class="o">=</span> <span class="n">soup</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="s1">&#39;tr&#39;</span><span class="p">,</span> <span class="p">{</span><span class="s1">&#39;class&#39;</span><span class="p">:</span> <span class="s1">&#39;TableBase-bodyTr &#39;</span><span class="p">})</span>
</code></pre></div>



<br/>
5) Capture a single row (and inspect for good measure)

<div class="codehilite"><pre><span></span><code><span class="n">row</span> <span class="o">=</span> <span class="n">rows</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
</code></pre></div>



<br/>
6) Use find to grab those tags that map to player name, position, and projected Fantasy Points

<div class="codehilite"><pre><span></span><code><span class="c1"># name</span>
<span class="n">row</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="s1">&#39;span&#39;</span><span class="p">,</span> <span class="p">{</span><span class="s1">&#39;class&#39;</span><span class="p">:</span> <span class="s1">&#39;CellPlayerName--long&#39;</span><span class="p">})</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="s1">&#39;a&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">text</span>

<span class="c1"># position</span>
<span class="p">(</span><span class="n">row</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="s1">&#39;span&#39;</span><span class="p">,</span> <span class="p">{</span><span class="s1">&#39;class&#39;</span><span class="p">:</span> <span class="s1">&#39;CellPlayerName--long&#39;</span><span class="p">})</span>
     <span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="s1">&#39;span&#39;</span><span class="p">,</span> <span class="p">{</span><span class="s1">&#39;class&#39;</span><span class="p">:</span> <span class="s1">&#39;CellPlayerName-position&#39;</span><span class="p">})</span><span class="o">.</span><span class="n">text</span>
<span class="p">)</span>

<span class="c1"># points</span>
<span class="nb">float</span><span class="p">(</span><span class="n">row</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="s1">&#39;td&#39;</span><span class="p">,</span> <span class="p">{</span><span class="s1">&#39;class&#39;</span><span class="p">:</span> <span class="s1">&#39;TableBase-bodyTd&#39;</span><span class="p">})[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">text</span><span class="p">)</span>
</code></pre></div>






    367.3



<br/>
<br/>
7) Wrap these find operations into a function

<div class="codehilite"><pre><span></span><code><span class="n">row</span> <span class="o">=</span> <span class="n">rows</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>

<span class="k">def</span> <span class="nf">parse_row</span><span class="p">(</span><span class="n">row</span><span class="p">):</span>
    <span class="n">meta</span> <span class="o">=</span> <span class="n">row</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="s1">&#39;span&#39;</span><span class="p">,</span> <span class="p">{</span><span class="s1">&#39;class&#39;</span><span class="p">:</span> <span class="s1">&#39;CellPlayerName--long&#39;</span><span class="p">})</span>
    <span class="n">name</span> <span class="o">=</span> <span class="n">meta</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="s1">&#39;a&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">text</span>
    <span class="n">position</span> <span class="o">=</span> <span class="n">meta</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="s1">&#39;span&#39;</span><span class="p">,</span> <span class="p">{</span><span class="s1">&#39;class&#39;</span><span class="p">:</span> <span class="s1">&#39;CellPlayerName-position&#39;</span><span class="p">})</span><span class="o">.</span><span class="n">text</span>
    <span class="n">points</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">row</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="s1">&#39;td&#39;</span><span class="p">,</span> <span class="p">{</span><span class="s1">&#39;class&#39;</span><span class="p">:</span> <span class="s1">&#39;TableBase-bodyTd&#39;</span><span class="p">})[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">text</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">name</span><span class="p">,</span> <span class="n">position</span><span class="p">,</span> <span class="n">points</span>

<span class="n">parse_row</span><span class="p">(</span><span class="n">row</span><span class="p">)</span>
</code></pre></div>






    ('Nikita Kucherov', 'RW', 367.3)



<br/>
<br/> 
8) Make sure that the function works for all the captured rows

<div class="codehilite"><pre><span></span><code><span class="n">forwards</span> <span class="o">=</span> <span class="p">[</span><span class="n">parse_row</span><span class="p">(</span><span class="n">row</span><span class="p">)</span> <span class="k">for</span> <span class="n">row</span> <span class="ow">in</span> <span class="n">rows</span><span class="p">]</span>
<span class="k">print</span><span class="p">(</span><span class="n">forwards</span><span class="p">[</span><span class="o">-</span><span class="mi">2</span><span class="p">:])</span>
</code></pre></div>



    [('Nick Shore', 'C', 166.6), ('Mats Zuccarello', 'RW', 165.8)]


<br/>
<br/>
9) Bundle up the logic so that it can be applied to multiple pages

<div class="codehilite"><pre><span></span><code><span class="k">def</span> <span class="nf">scrape_position</span><span class="p">(</span><span class="n">position</span><span class="p">):</span>
    <span class="n">base</span> <span class="o">=</span> <span class="n">f</span><span class="s1">&#39;https://www.cbssports.com/fantasy/hockey/stats&#39;</span>
    <span class="n">url</span> <span class="o">=</span> <span class="n">f</span><span class="s1">&#39;{base}/{position}/2019/season/projections/&#39;</span>
    <span class="n">html</span> <span class="o">=</span> <span class="n">get</span><span class="p">(</span><span class="n">url</span><span class="p">)</span>
    <span class="n">soup</span> <span class="o">=</span> <span class="n">Soup</span><span class="p">(</span><span class="n">html</span><span class="p">)</span>
    <span class="n">rows</span> <span class="o">=</span> <span class="n">soup</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="s1">&#39;tr&#39;</span><span class="p">,</span> <span class="p">{</span><span class="s1">&#39;class&#39;</span><span class="p">:</span> <span class="s1">&#39;TableBase-bodyTr &#39;</span><span class="p">})</span>
    <span class="n">data</span> <span class="o">=</span> <span class="p">[</span><span class="n">parse_row</span><span class="p">(</span><span class="n">row</span><span class="p">)</span> <span class="k">for</span> <span class="n">row</span> <span class="ow">in</span> <span class="n">rows</span><span class="p">]</span>
    <span class="k">return</span> <span class="n">data</span>
</code></pre></div>



<br/>
10) Scrape each page that contains player projection data

<div class="codehilite"><pre><span></span><code><span class="c1"># F for Forwards</span>
<span class="c1"># D for Defence</span>
<span class="c1"># G for goalies</span>

<span class="kn">import</span> <span class="nn">time</span>

<span class="n">data</span> <span class="o">=</span> <span class="p">[]</span>
<span class="k">for</span> <span class="n">position</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;F&#39;</span><span class="p">,</span> <span class="s1">&#39;D&#39;</span><span class="p">,</span> <span class="s1">&#39;G&#39;</span><span class="p">]:</span>
    <span class="n">d</span> <span class="o">=</span> <span class="n">scrape_position</span><span class="p">(</span><span class="n">position</span><span class="p">)</span>
    <span class="n">data</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">d</span><span class="p">)</span>
    <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
</code></pre></div>



<br/>
11) Stuff the captured data into a Pandas DataFrame

<div class="codehilite"><pre><span></span><code><span class="kn">import</span> <span class="nn">pandas</span> <span class="kn">as</span> <span class="nn">pd</span>

<span class="n">df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">columns</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;name&#39;</span><span class="p">,</span> <span class="s1">&#39;position&#39;</span><span class="p">,</span> <span class="s1">&#39;points&#39;</span><span class="p">])</span>
<span class="n">df</span><span class="o">.</span><span class="n">sample</span><span class="p">(</span><span class="mi">5</span><span class="p">)</span>
</code></pre></div>






<div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>name</th>
      <th>position</th>
      <th>points</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>205</th>
      <td>Martin Jones</td>
      <td>G</td>
      <td>386.8</td>
    </tr>
    <tr>
      <th>50</th>
      <td>Matt Duchene</td>
      <td>C</td>
      <td>219.4</td>
    </tr>
    <tr>
      <th>8</th>
      <td>Brad Marchand</td>
      <td>LW</td>
      <td>297.3</td>
    </tr>
    <tr>
      <th>198</th>
      <td>Marc-Edouard Vlasic</td>
      <td>D</td>
      <td>79.6</td>
    </tr>
    <tr>
      <th>51</th>
      <td>Vladimir Tarasenko</td>
      <td>RW</td>
      <td>217.7</td>
    </tr>
  </tbody>
</table>
</div>

<p><br/>
12) Calculate the <a href="https://en.wikipedia.org/wiki/Value_over_replacement_player">value over player replacement</a> score for each player</p>

<div class="codehilite"><pre><span></span><code><span class="n">pool_size</span> <span class="o">=</span> <span class="mi">8</span>
<span class="n">starters</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;C&#39;</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span> <span class="s1">&#39;LW&#39;</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span> <span class="s1">&#39;RW&#39;</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span> <span class="s1">&#39;D&#39;</span><span class="p">:</span> <span class="mi">2</span><span class="p">,</span> <span class="s1">&#39;G&#39;</span><span class="p">:</span> <span class="mi">1</span><span class="p">}</span>

<span class="k">for</span> <span class="n">position</span><span class="p">,</span> <span class="n">slots</span> <span class="ow">in</span> <span class="n">starters</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
    <span class="n">replacement</span> <span class="o">=</span> <span class="p">(</span>
        <span class="n">df</span><span class="p">[</span><span class="n">df</span><span class="p">[</span><span class="s1">&#39;position&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="n">position</span><span class="p">]</span>
        <span class="o">.</span><span class="n">sort_values</span><span class="p">(</span><span class="s1">&#39;points&#39;</span><span class="p">,</span> <span class="n">ascending</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span>
        <span class="o">.</span><span class="n">head</span><span class="p">(</span><span class="n">slots</span> <span class="o">*</span> <span class="n">pool_size</span><span class="p">)</span>
        <span class="p">[</span><span class="s1">&#39;points&#39;</span><span class="p">]</span>
        <span class="o">.</span><span class="n">mean</span><span class="p">()</span>
    <span class="p">)</span>
    <span class="n">df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">df</span><span class="p">[</span><span class="s1">&#39;position&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="n">position</span><span class="p">,</span> <span class="s1">&#39;vorp&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="s1">&#39;points&#39;</span><span class="p">]</span> <span class="o">-</span> <span class="n">replacement</span>
</code></pre></div>



<br/>
13) Re-rank and draft players according to their VORP rank
<br/>
<br/>

<div class="codehilite"><pre><span></span><code><span class="n">df</span><span class="p">[</span><span class="s1">&#39;vorp_rank&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="s1">&#39;vorp&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">rank</span><span class="p">(</span><span class="n">method</span><span class="o">=</span><span class="s1">&#39;average&#39;</span><span class="p">,</span> <span class="n">ascending</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span>
<span class="n">df</span><span class="o">.</span><span class="n">sort_values</span><span class="p">(</span><span class="s1">&#39;vorp_rank&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">head</span><span class="p">(</span><span class="mi">20</span><span class="p">)</span>
</code></pre></div>






<div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>name</th>
      <th>position</th>
      <th>points</th>
      <th>vorp</th>
      <th>vorp_rank</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>0</th>
      <td>Nikita Kucherov</td>
      <td>RW</td>
      <td>367.3</td>
      <td>77.75000</td>
      <td>1.0</td>
    </tr>
    <tr>
      <th>2</th>
      <td>Leon Draisaitl</td>
      <td>LW</td>
      <td>329.7</td>
      <td>51.87500</td>
      <td>2.0</td>
    </tr>
    <tr>
      <th>1</th>
      <td>Connor McDavid</td>
      <td>C</td>
      <td>346.2</td>
      <td>49.61250</td>
      <td>3.0</td>
    </tr>
    <tr>
      <th>200</th>
      <td>Andrei Vasilevskiy</td>
      <td>G</td>
      <td>437.1</td>
      <td>38.20000</td>
      <td>4.0</td>
    </tr>
    <tr>
      <th>100</th>
      <td>Brent Burns</td>
      <td>D</td>
      <td>235.8</td>
      <td>37.33125</td>
      <td>5.0</td>
    </tr>
    <tr>
      <th>101</th>
      <td>Dustin Byfuglien</td>
      <td>D</td>
      <td>233.5</td>
      <td>35.03125</td>
      <td>6.0</td>
    </tr>
    <tr>
      <th>102</th>
      <td>Morgan Rielly</td>
      <td>D</td>
      <td>225.6</td>
      <td>27.13125</td>
      <td>7.0</td>
    </tr>
    <tr>
      <th>6</th>
      <td>Alex Ovechkin</td>
      <td>LW</td>
      <td>304.2</td>
      <td>26.37500</td>
      <td>8.0</td>
    </tr>
    <tr>
      <th>3</th>
      <td>Patrick Kane</td>
      <td>RW</td>
      <td>313.2</td>
      <td>23.65000</td>
      <td>9.0</td>
    </tr>
    <tr>
      <th>103</th>
      <td>John Carlson</td>
      <td>D</td>
      <td>221.1</td>
      <td>22.63125</td>
      <td>10.0</td>
    </tr>
    <tr>
      <th>104</th>
      <td>Mark Giordano</td>
      <td>D</td>
      <td>218.8</td>
      <td>20.33125</td>
      <td>11.0</td>
    </tr>
    <tr>
      <th>8</th>
      <td>Brad Marchand</td>
      <td>LW</td>
      <td>297.3</td>
      <td>19.47500</td>
      <td>12.0</td>
    </tr>
    <tr>
      <th>5</th>
      <td>Mikko Rantanen</td>
      <td>RW</td>
      <td>305.0</td>
      <td>15.45000</td>
      <td>13.0</td>
    </tr>
    <tr>
      <th>105</th>
      <td>Tyson Barrie</td>
      <td>D</td>
      <td>212.8</td>
      <td>14.33125</td>
      <td>14.0</td>
    </tr>
    <tr>
      <th>106</th>
      <td>Kris Letang</td>
      <td>D</td>
      <td>212.6</td>
      <td>14.13125</td>
      <td>15.0</td>
    </tr>
    <tr>
      <th>4</th>
      <td>Nathan MacKinnon</td>
      <td>C</td>
      <td>310.7</td>
      <td>14.11250</td>
      <td>16.0</td>
    </tr>
    <tr>
      <th>201</th>
      <td>Frederik Andersen</td>
      <td>G</td>
      <td>411.9</td>
      <td>13.00000</td>
      <td>17.0</td>
    </tr>
    <tr>
      <th>202</th>
      <td>Braden Holtby</td>
      <td>G</td>
      <td>402.1</td>
      <td>3.20000</td>
      <td>18.0</td>
    </tr>
    <tr>
      <th>7</th>
      <td>Steven Stamkos</td>
      <td>C</td>
      <td>298.6</td>
      <td>2.01250</td>
      <td>19.0</td>
    </tr>
    <tr>
      <th>9</th>
      <td>Sidney Crosby</td>
      <td>C</td>
      <td>297.0</td>
      <td>0.41250</td>
      <td>20.0</td>
    </tr>
  </tbody>
</table>
</div>

<p><br/>
14) Profit</p>

      </div>
    </div>
  </body>
</html>